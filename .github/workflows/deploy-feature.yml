name: Deploy Feature Branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Feature branch to deploy"
        required: true
        type: string
      deploy_to_EC2_1:
        description: "Deploy to EC2_1"
        type: boolean
        default: false
      deploy_to_EC2_2:
        description: "Deploy to EC2_2"
        type: boolean
        default: false
      deploy_to_EC2_3:
        description: "Deploy to EC2_3"
        type: boolean
        default: false
      deploy_to_EC2_4:
        description: "Deploy to EC2_4"
        type: boolean
        default: false

jobs:
  deploy-feature:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - instance: EC2_1
            deploy: ${{ github.event.inputs.deploy_to_EC2_1 }}
          - instance: EC2_2
            deploy: ${{ github.event.inputs.deploy_to_EC2_2 }}
          - instance: EC2_3
            deploy: ${{ github.event.inputs.deploy_to_EC2_3 }}
          - instance: EC2_4
            deploy: ${{ github.event.inputs.deploy_to_EC2_4 }}
      fail-fast: false
    steps:
      - name: Skip unchecked instances
        if: matrix.deploy != 'true'
        run: echo "Skipping ${{ matrix.instance }} - not selected for deployment"
        
      - uses: actions/checkout@v4
        if: matrix.deploy == 'true'
        with:
          ref: ${{ github.event.inputs.branch }}
          
      - name: Set safe branch name
        if: matrix.deploy == 'true'
        id: prepare
        run: |
          branch="${{ github.event.inputs.branch }}"
          safe_branch=$(echo "$branch" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          echo "safe_branch=$safe_branch" >> $GITHUB_OUTPUT
          echo "Branch: $branch -> Safe: $safe_branch"
          
      - name: Build Docker image
        if: matrix.deploy == 'true'
        run: |
          branch="${{ github.event.inputs.branch }}"
          safe_branch="${{ steps.prepare.outputs.safe_branch }}"
          
          echo "Building Docker image for branch: $branch"
          
          # Build the Docker image
          docker build \
            --build-arg VERSION=${safe_branch}-$(git rev-parse --short HEAD) \
            -t location-tracker:${safe_branch} \
            .
          
          # Save image to tar file for transfer
          docker save location-tracker:${safe_branch} > location-tracker-${safe_branch}.tar
          
          echo "Docker image saved: location-tracker-${safe_branch}.tar"
          ls -la location-tracker-${safe_branch}.tar
          
      - name: Stop existing container and cleanup
        if: matrix.deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.instance)] }}
          username: ${{ secrets[format('{0}_USER', matrix.instance)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.instance)] }}
          script: |
            safe_branch="${{ steps.prepare.outputs.safe_branch }}"
            container_name="location-tracker-${safe_branch}"
            
            echo "Cleaning up existing deployment: $container_name"
            
            # Stop and remove existing container
            if docker ps -a --format '{{.Names}}' | grep -q "^${container_name}$"; then
              echo "Stopping existing container: $container_name"
              docker stop $container_name || echo "Container was not running"
              docker rm $container_name || echo "Failed to remove container"
            else
              echo "No existing container found: $container_name"
            fi
            
            # Remove old image
            if docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^location-tracker:${safe_branch}$"; then
              echo "Removing old image: location-tracker:${safe_branch}"
              docker rmi location-tracker:${safe_branch} || echo "Failed to remove image"
            fi
            
            # Create directory for SSL certificates
            mkdir -p /home/ec2-user/certs
            echo "Cleanup completed"
            
      - name: Upload Docker image
        if: matrix.deploy == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.instance)] }}
          username: ${{ secrets[format('{0}_USER', matrix.instance)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.instance)] }}
          source: "location-tracker-${{ steps.prepare.outputs.safe_branch }}.tar"
          target: "/tmp/"
          
      - name: Deploy SSL certificates
        if: matrix.deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.instance)] }}
          username: ${{ secrets[format('{0}_USER', matrix.instance)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.instance)] }}
          script: |
            # Create certificates directory
            mkdir -p /home/ec2-user/certs
            
            # Deploy SSL certificate (if provided)
            if [ -n "${{ secrets[format('{0}_SSL_CERT', matrix.instance)] }}" ]; then
              echo "Deploying SSL certificate for feature branch..."
              echo '${{ secrets[format('{0}_SSL_CERT', matrix.instance)] }}' > /home/ec2-user/certs/server.crt
              chmod 644 /home/ec2-user/certs/server.crt
            else
              echo "No SSL certificate provided"
            fi
            
            # Deploy SSL private key (if provided)
            if [ -n "${{ secrets[format('{0}_SSL_KEY', matrix.instance)] }}" ]; then
              echo "Deploying SSL private key for feature branch..."
              echo '${{ secrets[format('{0}_SSL_KEY', matrix.instance)] }}' > /home/ec2-user/certs/server.key
              chmod 600 /home/ec2-user/certs/server.key
            else
              echo "No SSL private key provided"
            fi
            
            echo "SSL certificate deployment completed"
            
      - name: Update Nginx configuration
        if: matrix.deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.instance)] }}
          username: ${{ secrets[format('{0}_USER', matrix.instance)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.instance)] }}
          script: |
            branch="${{ github.event.inputs.branch }}"
            safe_branch="${{ steps.prepare.outputs.safe_branch }}"
            nginx_location="/test/$branch"
            
            echo "Creating Nginx configuration for feature branch: $branch"
            echo "Safe branch name: $safe_branch"
            echo "Nginx location: $nginx_location"
            
            # Remove existing configuration if it exists
            sudo rm -f /etc/nginx/conf.d/location-tracker-${safe_branch}.conf
            
            # Create new nginx configuration for this feature branch
            sudo tee /etc/nginx/conf.d/location-tracker-${safe_branch}.conf > /dev/null <<EOF
            # Feature branch: ${branch}
            server {
                listen 80;
                server_name ${{ secrets[format('{0}_DOMAIN', matrix.instance)] }};
                
                location ${nginx_location} {
                    proxy_pass http://127.0.0.1:8081;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
                
                location ${nginx_location}/ws {
                    proxy_pass http://127.0.0.1:8081;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "Upgrade";
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF
            
            # Test nginx configuration
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo "Nginx configuration updated successfully"
            else
              echo "ERROR: Nginx configuration test failed"
              cat /etc/nginx/conf.d/location-tracker-${safe_branch}.conf
              exit 1
            fi
            
      - name: Load and start Docker container
        if: matrix.deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.instance)] }}
          username: ${{ secrets[format('{0}_USER', matrix.instance)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.instance)] }}
          script: |
            branch="${{ github.event.inputs.branch }}"
            safe_branch="${{ steps.prepare.outputs.safe_branch }}"
            container_name="location-tracker-${safe_branch}"
            
            echo "Loading and starting Docker container: $container_name"
            
            # Load Docker image
            if [ -f "/tmp/location-tracker-${safe_branch}.tar" ]; then
              echo "Loading Docker image from tar file..."
              docker load < /tmp/location-tracker-${safe_branch}.tar
              
              # Verify image was loaded
              if docker images | grep -q "location-tracker.*${safe_branch}"; then
                echo "Docker image loaded successfully"
              else
                echo "ERROR: Docker image failed to load"
                exit 1
              fi
            else
              echo "ERROR: Docker image tar file not found"
              ls -la /tmp/location-tracker-*.tar || echo "No tar files found"
              exit 1
            fi
            
            # Start the container
            echo "Starting Docker container..."
            docker run -d \
              --name $container_name \
              --restart unless-stopped \
              -p 8081:8080 \
              -p 8444:8443 \
              -p 5052:5051 \
              -v /home/ec2-user/certs:/root/certs:ro \
              -e DB_HOST="${{ secrets[format('{0}_DB_HOST', matrix.instance)] }}" \
              -e DB_NAME="${{ secrets[format('{0}_DB_NAME', matrix.instance)] }}" \
              -e DB_USER="${{ secrets[format('{0}_DB_USER', matrix.instance)] }}" \
              -e DB_PASSWORD="${{ secrets[format('{0}_DB_PASSWORD', matrix.instance)] }}" \
              -e DB_SSLMODE=require \
              -e PORT=8080 \
              -e HTTPS_PORT=8443 \
              -e UDP_PORT=5051 \
              -e DOMAIN="${{ secrets[format('{0}_DOMAIN', matrix.instance)] }}" \
              -e AUTO_TLS=false \
              location-tracker:${safe_branch}
            
            # Wait for container to start
            echo "Waiting for container to start..."
            sleep 20
            
            # Verify container is running
            if docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
              echo "Container started successfully: $container_name"
              docker ps | grep $container_name
            else
              echo "ERROR: Container failed to start"
              echo "Container status:"
              docker ps -a | grep $container_name || echo "Container not found"
              echo "Container logs:"
              docker logs $container_name || echo "Failed to get logs"
              exit 1
            fi
            
            # Clean up tar file
            rm -f /tmp/location-tracker-${safe_branch}.tar
            
      - name: Health check and final verification
        if: matrix.deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets[format('{0}_HOST', matrix.instance)] }}
          username: ${{ secrets[format('{0}_USER', matrix.instance)] }}
          key: ${{ secrets[format('{0}_SSH_KEY', matrix.instance)] }}
          script: |
            branch="${{ github.event.inputs.branch }}"
            safe_branch="${{ steps.prepare.outputs.safe_branch }}"
            container_name="location-tracker-${safe_branch}"
            
            echo "=== Final Health Check ==="
            
            # Check container logs
            echo "Recent container logs:"
            docker logs --tail 20 $container_name
            
            # Test health endpoint
            echo "Testing health endpoint..."
            max_attempts=5
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Health check attempt $attempt/$max_attempts..."
              
              if curl -f -s http://localhost:8081/api/health; then
                echo ""
                echo "Health check PASSED"
                
                # Display success information
                echo "=== Deployment Successful ==="
                echo "Feature branch: $branch"
                echo "Container: $container_name"
                echo "Local health: http://localhost:8081/api/health"
                echo "Public URL: http://${{ secrets[format('{0}_DOMAIN', matrix.instance)] }}/test/$branch"
                
                # Show container status
                echo "Container status:"
                docker ps | head -1  # Header
                docker ps | grep $container_name
                
                exit 0
              else
                echo "Health check failed (attempt $attempt/$max_attempts)"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting 10 seconds before retry..."
                  sleep 10
                fi
              fi
              
              attempt=$((attempt + 1))
            done
            
            # If we get here, all health checks failed
            echo "ERROR: All health checks failed"
            echo "Container status:"
            docker ps -a | grep $container_name
            echo "Recent container logs:"
            docker logs --tail 50 $container_name
            exit 1