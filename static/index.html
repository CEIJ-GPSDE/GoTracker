<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-time Location Tracker</title>
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <script>
    window.APP_CONFIG = {
      basePath: '${BASE_PATH}',
      instanceName: '${INSTANCE_NAME}',
      branchName: '${BRANCH_NAME}'
    };
  </script>

  <div class="container">
    <div class="header">
      <h1>üåç Real-time Location Tracker</h1>
      <p>Monitoring device locations with live updates and historical view</p>
      <div style="margin-top: 15px;">
        <select id="language-selector"
          style="padding: 8px 12px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-weight: 500; cursor: pointer;">
          <option value="en" style="color: #374151; background: white;">English</option>
          <option value="es" style="color: #374151; background: white;">Espa√±ol</option>
        </select>
      </div>
    </div>

    <div class="dashboard">
      <div class="map-container">
        <!-- Connection Status - Top Center -->
        <div class="connection-status-top" id="connection-status-top">
          <div id="connection-status" class="status disconnected">
            <div class="status-dot"></div>
            <span>Connecting...</span>
          </div>
        </div>
        
        <!-- Legends - Top Left -->
        <div class="top-left-controls">
          <!-- Device Legend -->
          <div class="device-legend" id="device-legend">
            <div class="device-legend-header" onclick="window.locationTracker.toggleDeviceLegend()">
              <h4>
                üì± <span id="devices-text">Devices</span>
                <span id="device-count" style="font-size: 12px; font-weight: normal; color: #6b7280;">0</span>
              </h4>
              <button class="device-legend-toggle">‚ñº</button>
            </div>
            <div id="legend-items"></div>
            <button class="center-devices-btn" id="center-devices-btn" onclick="window.locationTracker.centerOnSelectedDevices()">
              üéØ <span id="center-devices-text">Center on Devices</span>
            </button>
          </div>
          
          <!-- Geofence Legend -->
          <div class="geofence-legend" id="geofence-legend">
            <div class="geofence-legend-header" onclick="window.locationTracker.geofenceManager?.toggleGeofenceLegend()">
              <h4>
                üó∫Ô∏è <span id="geofences-text">Geofences</span>
                <span id="geofence-count" style="font-size: 12px; font-weight: normal; color: #6b7280;">0</span>
              </h4>
              <button class="geofence-legend-toggle">‚ñº</button>
            </div>
            <div id="geofence-legend-items"></div>
            <button class="center-geofences-btn" id="center-geofences-btn" onclick="window.locationTracker.geofenceManager?.centerOnGeofences()">
              üéØ <span id="center-geofences-text">Center on Geofences</span>
            </button>
          </div>
        </div>
        
        <div class="time-filter-indicator" id="time-filter-indicator">
          <div id="time-filter-text">-</div>
        </div>
        
        <div class="map-controls">
          <button id="track-latest-btn" class="track-btn enabled">
            <div class="track-icon"></div>
            <span>Track Latest</span>
          </button>
          <button id="history-mode-btn" class="history-btn">
            <span>üìÖ</span>
            <span>History Mode</span>
          </button>
          
          <!-- Geofence Management Buttons -->
          <button id="draw-geofence-btn" class="geofence-control-btn" title="Draw Geofence">
            <span>üñäÔ∏è</span>
          </button>
          <button id="toggle-geofences-btn" class="geofence-control-btn" title="Toggle Geofences">
            <span>üëÅÔ∏è</span>
          </button>
          <button id="open-geofence-menu-btn" class="geofence-control-btn" title="Geofence Management">
            <span>üó∫Ô∏è</span>
          </button>
          
          <button id="change-filter-btn" class="history-btn"
            style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706);">
            <span>üîÑ</span>
            <span>Change Filter</span>
          </button>
          <button id="live-mode-btn" class="history-btn"
            style="display: none; background: linear-gradient(135deg, #dc2626, #b91c1c);">
            <span>üî¥</span>
            <span>Live Mode</span>
          </button>
        </div>
        
        <div id="map"></div>
        
        <div class="no-filter-overlay" id="no-filter-overlay">
          <h3 id="no-filter-title">‚ö†Ô∏è No Time Filter Applied</h3>
          <p id="no-filter-message">Please configure a time filter in History Settings to view historical data.</p>
          <button class="btn" id="no-filter-open-settings-btn">
            <span id="no-filter-btn-text">Open History Settings</span>
          </button>
          <button class="btn secondary" id="no-filter-dismiss-btn">
            <span id="no-filter-dismiss-text">Dismiss</span>
          </button>
        </div>

        <div class="no-results-overlay" id="no-results-overlay" style="border-color: #ef4444; z-index: 10600;">
          <h3 id="empty-results-title">‚ö†Ô∏è No Results Found</h3>
          <p id="empty-results-message">No location data matches your filter criteria. Try adjusting the parameters.</p>
          <button class="btn" id="empty-results-adjust-btn-element">
            <span id="empty-results-adjust-btn">Adjust Filters</span>
          </button>
          <button class="btn secondary" id="empty-results-dismiss-btn-element">
            <span id="empty-results-dismiss-btn">Dismiss</span>
          </button>
        </div>
        
        <div class="mode-indicator live-mode" id="mode-indicator">
          <div class="mode-indicator-dot"></div>
          <span>üî¥ LIVE MODE</span>
        </div>
        
      <!-- Menu Button - Bottom Right -->
        <div class="bottom-right-menu">
          <button id="menu-toggle-btn-bottom" class="menu-toggle-btn-bottom">
            <span>‚öôÔ∏è</span>
            <span id="menu-text">Menu</span>
          </button>
        </div>

        <div class="route-legend" id="route-legend" style="display: none;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; border: 2px solid white;">
            </div>
            <span style="font-size: 11px;" id="legend-start">Start</span>
            <div
              style="flex: 1; height: 4px; background: linear-gradient(to right, #10b981, #f59e0b, #ef4444); margin: 0 5px;">
            </div>
            <span style="font-size: 11px;" id="legend-end">End</span>
            <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%; border: 2px solid white;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Menu Popup -->
  <div class="popup-menu" id="popup-menu">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Controls & Information</h2>
        <button class="popup-close" id="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="menu-tabs">
          <button class="tab-button active" data-tab="controls">‚öôÔ∏è Controls</button>
          <button class="tab-button" data-tab="locations">üìç Locations</button>
          <button class="tab-button" data-tab="geofences">üó∫Ô∏è Geofences</button>
        </div>

        <!-- Controls Tab -->
        <div class="tab-content active" id="controls-tab">
          <div class="card">
            <div class="card-body">
              <div class="control-group">
                <label for="history-limit">History Limit:</label>
                <input type="number" id="history-limit" value="50" min="10" max="500">
              </div>
              <button class="btn" id="refresh-data-btn" onclick="locationTracker.refreshData()">Refresh Data</button>
            </div>
            <div class="control-item">
              <label style="display:flex; align-items:center; gap:6px; cursor:pointer; width:100%;">
                <input type="checkbox" id="toggle-trace-dots" checked>
                <span id="trace-dots-label">Show trace dots</span>
              </label>
            </div>
            <div class="control-item">
              <label style="display:flex; align-items:center; gap:6px; cursor:pointer; width:100%;">
                <input type="checkbox" id="toggle-clustering">
                <span>Use marker clustering (>100 points)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Locations Tab -->
        <div class="tab-content" id="locations-tab">
          <div class="card">
            <div class="card-body">
              <div class="location-list" id="location-list">
                <div class="loading">
                  <div class="spinner"></div>Loading locations...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Geofences Tab -->
        <div class="tab-content" id="geofences-tab">
          <div class="card">
            <div class="card-body">
              <h4 style="margin-bottom: 15px; color: #374151;">üó∫Ô∏è <span id="geofence-management-title">Geofence Management</span></h4>
              
              <!-- Actions -->
              <div class="button-group" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="window.locationTracker.geofenceManager?.startDrawing()">
                  üñäÔ∏è <span id="draw-geofence-btn-text">Draw New Geofence</span>
                </button>
                <button class="btn secondary" onclick="window.locationTracker.geofenceManager?.loadGeofences()">
                  üîÑ <span id="reload-geofences-btn-text">Reload Geofences</span>
                </button>
                <button class="btn secondary" onclick="window.locationTracker.geofenceManager?.toggleGeofenceVisibility()">
                  üëÅÔ∏è <span id="toggle-visibility-btn-text">Toggle Visibility</span>
                </button>
              </div>

              <!-- Statistics -->
              <div class="geofence-stats" style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h5 style="margin: 0 0 10px 0; color: #374151; font-size: 13px;">
                  üìä <span id="geofence-stats-title">Statistics</span>
                </h5>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                  <div class="stat-item" style="padding: 8px; background: white; border-radius: 6px;">
                    <span class="stat-label" style="font-size: 11px;" id="total-geofences-label">Total Geofences:</span>
                    <span class="stat-value" id="total-geofences-count" style="font-size: 16px;">0</span>
                  </div>
                  <div class="stat-item" style="padding: 8px; background: white; border-radius: 6px;">
                    <span class="stat-label" style="font-size: 11px;" id="active-geofences-label">Active:</span>
                    <span class="stat-value" id="active-geofences-count" style="font-size: 16px;">0</span>
                  </div>
                  <div class="stat-item" style="padding: 8px; background: white; border-radius: 6px;">
                    <span class="stat-label" style="font-size: 11px;" id="devices-inside-label">Devices Inside:</span>
                    <span class="stat-value" id="devices-inside-count" style="font-size: 16px;">0</span>
                  </div>
                  <div class="stat-item" style="padding: 8px; background: white; border-radius: 6px;">
                    <span class="stat-label" style="font-size: 11px;" id="total-violations-label">Total Alerts:</span>
                    <span class="stat-value" id="total-violations-count" style="font-size: 16px;">0</span>
                  </div>
                </div>
              </div>

              <!-- Geofence List -->
              <div id="geofence-list" style="max-height: 350px; overflow-y: auto;">
                <h5 style="margin: 0 0 10px 0; color: #374151; font-size: 13px;">
                  üìç <span id="geofence-list-title">Active Geofences</span>
                </h5>
                <div id="geofence-items">
                  <div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">
                    <span id="no-geofences-msg">No geofences created yet</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Tab - Hidden but kept for stats polling -->
        <div class="tab-content" id="stats-tab" style="display: none !important;">
          <div class="card">
            <div class="card-body stats">
              <div class="stat-item">
                <span class="stat-label">Connected Clients:</span>
                <span class="stat-value" id="connected-clients">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Total Locations:</span>
                <span class="stat-value" id="total-locations">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Active Devices:</span>
                <span class="stat-value" id="active-devices">-</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Last Update:</span>
                <span class="stat-value" id="last-update">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Configuration Popup -->
  <div class="popup-menu" id="history-config-popup">
    <div class="popup-content">
      <div class="popup-header">
        <h2>üìÖ Historical View Configuration</h2>
        <button class="popup-close" id="history-config-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="menu-tabs">
          <button class="tab-button active" data-tab="time-filter" id="time-filter-tab-btn">‚è±Ô∏è <span
              id="time-filter-tab-label">Time Filter</span></button>
          <button class="tab-button" data-tab="location-filter" id="location-filter-tab-btn">üìç <span
              id="location-filter-tab-label">Location Filter</span></button>
        </div>

        <!-- Time Filter Tab -->
        <div class="tab-content active" id="time-filter-tab">
          <div class="card">
            <div class="card-body">
              <div class="historical-controls active" id="historical-controls-popup">
                <div class="quick-ranges">
                  <button class="quick-range-btn" data-hours="1">1h</button>
                  <button class="quick-range-btn" data-hours="6">6h</button>
                  <button class="quick-range-btn" data-hours="24">24h</button>
                  <button class="quick-range-btn" data-hours="168">1w</button>
                  <button class="quick-range-btn" data-hours="8760">1y</button>
                </div>
                <div class="time-range-controls">
                  <div class="control-group">
                    <label for="start-time-popup">From:</label>
                    <input type="datetime-local" id="start-time-popup">
                  </div>
                  <div class="control-group">
                    <label for="end-time-popup">To:</label>
                    <input type="datetime-local" id="end-time-popup">
                  </div>
                </div>
                <div class="validation-error" id="validation-error"></div>
                <button class="btn" id="apply-time-filter-popup">Apply Time Filter</button>
                <button class="btn secondary" id="clear-time-filter-popup">Clear Filter</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Location Filter Tab -->
        <div class="tab-content" id="location-filter-tab">
          <div class="card">
            <div class="card-body">
              <div class="control-group">
                <label for="location-lat-input" id="location-lat-label">Latitude:</label>
                <input type="number" id="location-lat-input" step="0.000001" placeholder="e.g., 40.7128">
              </div>
              <div class="control-group">
                <label for="location-lng-input" id="location-lng-label">Longitude:</label>
                <input type="number" id="location-lng-input" step="0.000001" placeholder="e.g., -74.0060">
              </div>
              <button class="btn secondary" id="select-on-map-btn" style="margin-bottom: 15px;">
                <span id="select-on-map-text">üó∫ Select on Map</span>
              </button>
              <div class="control-group">
                <label for="location-radius-input" id="location-radius-label">Radius (km):</label>
                <input type="number" id="location-radius-input" value="0.5" min="0.1" max="50" step="0.1">
              </div>
              <div class="validation-error" id="location-validation-error"></div>
              <button class="btn" id="apply-location-filter">Apply Location Filter</button>
              <button class="btn secondary" id="clear-location-filter">Clear Filter</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>
</body>

</html>
