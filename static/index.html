<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Location Tracker</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üåç Real-time Location Tracker</h1>
        <p>Monitoring device locations with live updates and historical view</p>
        <div style="margin-top: 15px;">
            <select id="language-selector" style="padding: 8px 12px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-weight: 500; cursor: pointer;">
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
            </select>
        </div>
    </div>

    <div class="dashboard">
        <div class="map-container">
            <div class="map-overlay">
                <div id="connection-status" class="status disconnected">
                    <div class="status-dot"></div>
                    <span>Connecting...</span>
                </div>
            </div>
            <div class="time-filter-indicator" id="time-filter-indicator">
                <div id="time-filter-text">-</div>
            </div>
            <div class="map-controls">
                <button id="track-latest-btn" class="track-btn enabled">
                    <div class="track-icon"></div>
                    <span>Track Latest</span>
                </button>
                <button id="history-mode-btn" class="history-btn">
                    <span>üìÖ</span>
                    <span>History Mode</span>
                </button>
                <button id="history-config-btn" class="history-btn" style="display: none;">
                    <span>üìÖ</span>
                    <span>History Settings</span>
                </button>
                <button id="live-mode-btn" class="history-btn" style="display: none; background: linear-gradient(135deg, #dc2626, #b91c1c);">
                    <span>üìç</span>
                    <span>Live Mode</span>
                </button>
                <button id="menu-toggle-btn" class="menu-toggle-btn">
                    <span>‚öôÔ∏è</span>
                    <span>Menu</span>
                </button>
            </div>
            <div id="map"></div>
            <div class="no-filter-overlay" id="no-filter-overlay">
                <h3 id="no-filter-title">‚ö†Ô∏è No Time Filter Applied</h3>
                <p id="no-filter-message">Please configure a time filter in History Settings to view historical data.</p>
                <button class="btn" onclick="locationTracker.hideNoFilterOverlay(); locationTracker.openHistoryConfigPopup();">
                    <span id="no-filter-btn-text">Open History Settings</span>
                </button>
                <button class="btn secondary" onclick="locationTracker.hideNoFilterOverlay()">
                    <span id="no-filter-dismiss-text">Dismiss</span>
                </button>
            </div>
            <div class="mode-indicator live-mode" id="mode-indicator">
                <div class="mode-indicator-dot"></div>
                <span>üî¥ LIVE MODE</span>
            </div>
            <div class="route-legend" id="route-legend" style="display: none;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; border: 2px solid white;"></div>
                    <span style="font-size: 11px;" id="legend-start">Start</span>
                    <div style="flex: 1; height: 4px; background: linear-gradient(to right, #10b981, #f59e0b, #ef4444); margin: 0 5px;"></div>
                    <span style="font-size: 11px;" id="legend-end">End</span>
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%; border: 2px solid white;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Menu Popup -->
<div class="popup-menu" id="popup-menu">
    <div class="popup-content">
        <div class="popup-header">
            <h2>Controls & Information</h2>
            <button class="popup-close" id="popup-close">√ó</button>
        </div>
        <div class="popup-body">
            <div class="menu-tabs">
                <button class="tab-button active" data-tab="controls">‚öôÔ∏è Controls</button>
                <button class="tab-button" data-tab="locations">üìç Locations</button>
            </div>
            
            <!-- Controls Tab -->
            <div class="tab-content active" id="controls-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="control-group">
                            <label for="device-filter">Filter by Device:</label>
                            <select id="device-filter"><option value="">All Devices</option></select>
                        </div>
                        <div class="control-group">
                            <label for="history-limit">History Limit:</label>
                            <input type="number" id="history-limit" value="50" min="10" max="500">
                        </div>
                        <button class="btn" id="refresh-data-btn" onclick="locationTracker.refreshData()">Refresh Data</button>
                    </div>
                    <div class="control-item">
                      <label style="display:flex; align-items:center; gap:6px; cursor:pointer; width:100%;">
                        <input type="checkbox" id="toggle-trace-dots" checked>
                        <span id="trace-dots-label">Show trace dots</span>
                      </label>
                    </div>
                </div>
            </div>
            
            <!-- Locations Tab -->
            <div class="tab-content" id="locations-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="location-list" id="location-list">
                            <div class="loading"><div class="spinner"></div>Loading locations...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Tab - Hidden but kept for stats polling -->
            <div class="tab-content" id="stats-tab" style="display: none !important;">
                <div class="card">
                    <div class="card-body stats">
                        <div class="stat-item">
                            <span class="stat-label">Connected Clients:</span>
                            <span class="stat-value" id="connected-clients">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Locations:</span>
                            <span class="stat-value" id="total-locations">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Active Devices:</span>
                            <span class="stat-value" id="active-devices">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Last Update:</span>
                            <span class="stat-value" id="last-update">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Configuration Popup -->
<div class="popup-menu" id="history-config-popup">
    <div class="popup-content">
        <div class="popup-header">
            <h2>üìÖ Historical View Configuration</h2>
            <button class="popup-close" id="history-config-close">√ó</button>
        </div>
        <div class="popup-body">
            <div class="menu-tabs">
                <button class="tab-button active" data-tab="time-filter" id="time-filter-tab-btn">‚è±Ô∏è <span id="time-filter-tab-label">Time Filter</span></button>
                <button class="tab-button" data-tab="location-filter" id="location-filter-tab-btn">üìç <span id="location-filter-tab-label">Location Filter</span></button>
            </div>

            <!-- No Filter Selected Tab (Default) -->
            <div class="tab-content" id="no-filter-selected-tab" style="display: none;">
                <div class="card">
                    <div class="card-body" style="text-align: center; padding: 60px 30px;">
                        <h3 style="color: white; margin-bottom: 15px;" id="no-filter-selected-title">üìç No filter selected</h3>
                        <p style="color: #9ca3af; margin-bottom: 10px;" id="please-select-filter">Please select a time range or location to view historical data.</p>
                        <p style="color: #9ca3af; font-size: 14px;" id="select-filter-tab">Choose a tab above to configure your filter.</p>
                    </div>
                </div>
            </div>

            <!-- Time Filter Tab -->
            <div class="tab-content active" id="time-filter-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="historical-controls active" id="historical-controls-popup">
                            <div class="quick-ranges">
                                <button class="quick-range-btn" data-hours="1">1h</button>
                                <button class="quick-range-btn" data-hours="6">6h</button>
                                <button class="quick-range-btn" data-hours="24">24h</button>
                                <button class="quick-range-btn" data-hours="168">1w</button>
                                <button class="quick-range-btn" data-hours="0">All</button>
                            </div>
                            <div class="time-range-controls">
                                <div class="control-group">
                                    <label for="start-time-popup">From:</label>
                                    <input type="datetime-local" id="start-time-popup">
                                </div>
                                <div class="control-group">
                                    <label for="end-time-popup">To:</label>
                                    <input type="datetime-local" id="end-time-popup">
                                </div>
                            </div>
                            <div class="validation-error" id="validation-error"></div>
                            <button class="btn" id="apply-time-filter-popup">Apply Time Filter</button>
                            <button class="btn secondary" id="clear-time-filter-popup">Clear Filter</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Filter Tab -->
            <div class="tab-content" id="location-filter-tab">
                <div class="card">
                    <div class="card-body">
                        <div class="control-group">
                            <label for="location-lat-input" id="location-lat-label">Latitude:</label>
                            <input type="number" id="location-lat-input" step="0.000001" placeholder="e.g., 40.7128">
                        </div>
                        <div class="control-group">
                            <label for="location-lng-input" id="location-lng-label">Longitude:</label>
                            <input type="number" id="location-lng-input" step="0.000001" placeholder="e.g., -74.0060">
                        </div>
                        <button class="btn secondary" id="select-on-map-btn" style="margin-bottom: 15px;">
                            <span id="select-on-map-text">üìç Select on Map</span>
                        </button>
                        <div class="control-group">
                            <label for="location-radius-input" id="location-radius-label">Radius (km):</label>
                            <input type="number" id="location-radius-input" value="0.5" min="0.1" max="50" step="0.1">
                        </div>
                        <div class="validation-error" id="location-validation-error"></div>
                        <button class="btn" id="apply-location-filter">Apply Location Filter</button>
                        <button class="btn secondary" id="clear-location-filter">Clear Filter</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Empty Results Popup -->
<div class="filter-popup" id="empty-results-popup">
    <h3 style="margin: 0 0 10px 0; color: #374151;">No Results Found</h3>
    <p style="margin: 0 0 15px 0; color: #6b7280;">The selected time range contains no location data.</p>
    <button class="btn" onclick="locationTracker.closeEmptyResultsPopup()">OK</button>
</div>

<script src="app.js"></script>
</body>
</html>
